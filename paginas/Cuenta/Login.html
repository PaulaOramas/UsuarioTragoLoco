<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Perfil de Usuario | Trago Loco</title>

    <!-- Fuente Pacifico -->
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet" />
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="../../css/oscuro.css" rel="stylesheet" />
    <link href="../../css/Site.css" rel="stylesheet" />

    <!-- CSS personalizado -->
    <style>
        /* Fondo de la página */
        .fondo-crema {
            background-color: #f8f9fa;
        }

        /* Estilo del botón "Ver detalles" */
        .btn-outline-morado {
            border-color: #6b1e25;
            color: #6b1e25;
            background-color: transparent;
            font-weight: bold;
        }

        .btn-outline-morado:hover {
            background-color: #6b1e25;
            color: white;
        }

        /* Estilo de la tabla con fondo morado */
        .table-dark {
            background-color: #6b1e25;
            color: white;
        }

        /* Estilo de los encabezados dentro de la tabla */
        .table-dark th {
            background-color: #6b1e25;
            color: white !important;
            font-weight: bold;
        }

        /* Estilo de las celdas */
        .table-dark td {
            border: 1px solid #6b1e25;
        }

        /* Títulos de la página */
        .sub-titulo {
            color: #6b1e25;
            font-weight: bold;
        }

        /* Título principal */
        .titulo-principal {
            font-family: 'Pacifico', cursive;
            font-size: 2rem;
            color: #6b1e25;
        }

        /* Fondo del modal */
        .modal-header.bg-morado {
            background-color: #6b1e25;
        }

        .modal-header.bg-morado .modal-title {
            color: white;
        }

        /* Modal para los detalles de factura */
        .modal-content {
            border-radius: 15px;
        }

        /* Fondo de la tabla dentro del modal */
        .table-bordered {
            border-color: #6b1e25;
        }

        /* Estilo de la tabla dentro del modal */
        .table-bordered th,
        .table-bordered td {
            color: black;
        }

        /* Estilo para el contenedor de login */
        .login-container {
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
            border: 1px solid #6b1e25;
            border-radius: 10px;
            background-color: #fff;
        }

        /* Estilo para la tabla de facturas */
        .table-striped tbody tr:nth-of-type(odd) {
            background-color: #f9f9f9;
        }

        /* Botón de ver detalles */
        .btn-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
        }

        /* Mejora en la apariencia de las filas de la tabla */
        .table-striped tbody tr:hover {
            background-color: #eaeaea;
        }

        /* Estilo del contenedor de login */
        .login-container {
            background: #fff;
            padding: 2rem 2.5rem;
            border-radius: 1rem;
            box-shadow: 0 10px 30px rgba(107, 30, 37, 0.15);
            max-width: 400px;
            width: 100%;
            text-align: center;
            margin-top: 2rem;
            margin-bottom: 2rem;
        }

        /* Título dentro del login */
        .login-container h2 {
            font-family: 'Pacifico', cursive;
            color: #6b1e25;
            margin-bottom: 1.5rem;
            font-size: 2rem;
        }

        /* Estilo para los campos de entrada (input) */
        input {
            border: 1px solid #6b1e25;
            border-radius: 8px;
            padding: 0.8rem;
            width: 100%;
            margin-bottom: 1.2rem;
            font-size: 1rem;
        }

        /* Estilo de los textos de ayuda debajo de los inputs */
        .form-text {
            color: #6b1e25;
            font-size: 0.9rem;
        }

        /* Estilo del botón "Ingresar" */
        .btn-morado {
            background-color: #6b1e25;
            color: #f5f5dc;
            font-weight: 700;
            border-radius: 30px;
            padding: 0.6rem 1.5rem;
            transition: background-color 0.3s ease;
            border: none;
            margin-top: 1rem;
            width: 100%;
            cursor: pointer;
        }

        .btn-morado:hover,
        .btn-morado:focus {
            background-color: #a44b5a;
            color: #fff;
            outline: none;
            box-shadow: 0 0 12px #a44b5aaa;
        }

        /* Estilo de los enlaces */
        a {
            color: #6b1e25;
            text-decoration: none;
            font-weight: 600;
        }

        a:hover {
            color: #a44b5a;
        }

        /* Estilo de los mensajes de error */
        .alert {
            margin-top: 1rem;
            padding: 0.8rem;
            border-radius: 10px;
        }

        /* Estilo de la alerta de error */
        .alert-danger {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>

<body class="fondo-crema">

    <!-- Header dinámico -->
    <div id="header-container"></div>

    <main class="container my-5 p-4 rounded shadow bg-white">
        <h1 class="text-center mb-4 titulo-principal">Perfil de Usuario</h1>

        <!-- Contenedor de login y datos del perfil -->
        <div id="contenidoPerfil"></div>
    </main>

    <!-- Footer dinámico -->
    <div id="footer-container" class="mt-5"></div>

    <!-- Modal detalle factura -->
    <div class="modal fade" id="modalDetalleFactura" tabindex="-1" aria-labelledby="modalDetalleFacturaLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-morado text-white">
                    <h5 class="modal-title" id="modalDetalleFacturaLabel">Detalle de Factura</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    <table class="table table-bordered text-center">
                        <thead>
                            <tr>
                                <th>Producto</th>
                                <th>Cantidad</th>
                                <th>Precio Unitario</th>
                                <th>Subtotal</th>
                            </tr>
                        </thead>
                        <tbody id="detalle-factura-body">
                            <!-- Detalles dinámicos -->
                        </tbody>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            // Cargar el Header y Footer
            fetch('../../paginas/Shared/Header.html')
                .then(res => res.text())
                .then(data => {
                    document.getElementById('header-container').innerHTML = data;
                    actualizarUIUsuario(); // Llamamos la función después de cargar el header
                });

            fetch('../../paginas/Shared/Footer.html')
                .then(res => res.text())
                .then(data => {
                    document.getElementById('footer-container').innerHTML = data;
                });

            // Verificar si el usuario está logueado
            const usuarioActual = localStorage.getItem('usuario');

            // Si el usuario está logueado, mostrar sus datos
            if (usuarioActual) {
                mostrarPerfil(usuarioActual);
            } else {
                mostrarLogin();
            }
        });

        // Mostrar perfil del usuario
        function mostrarPerfil(usuario) {
            // Llamar a la API para obtener los datos del usuario
            fetch(`https://eltragolocorest.runasp.net/api/Usuario?ciRuc=${usuario}`)
                .then(response => response.json())
                .then(usuarioData => {
                    // Cambiar la ciudad según el valor que venga de la API
                    let ciudad = "Desconocido";
                    switch (usuarioData.USU_CIUDAD) {
                        case "UIO":
                            ciudad = "Quito";
                            break;
                        case "CUE":
                            ciudad = "Cuenca";
                            break;
                        case "GYE":
                            ciudad = "Guayaquil";
                            break;
                    }

                    // Mostrar los datos del perfil en la página
                    const contenidoPerfil = document.getElementById('contenidoPerfil');
                    contenidoPerfil.innerHTML = `
    <h2 class="mb-3 sub-titulo text-center">Datos Personales</h2>
    <div class="row g-3">
        <div class="col-md-6 text-start">
            <div class="mb-2"><span class="fw-bold">Cédula/RUC:</span> <span class="text-dark">${usuarioData.USU_CI_RUC}</span></div>
            <div class="mb-2"><span class="fw-bold">Nombre:</span> <span class="text-dark">${usuarioData.USU_NOMBRE}</span></div>
            <div class="mb-2"><span class="fw-bold">Email:</span> <span class="text-dark">${usuarioData.USU_EMAIL}</span></div>
        </div>
        <div class="col-md-6 text-start">
            <div class="mb-2"><span class="fw-bold">Teléfono:</span> <span class="text-dark">${usuarioData.USU_TELEFONO}</span></div>
            <div class="mb-2"><span class="fw-bold">Dirección:</span> <span class="text-dark">${usuarioData.USU_DIRECCION}</span></div>
            <div class="mb-2"><span class="fw-bold">Ciudad:</span> <span class="text-dark">${ciudad}</span></div>
        </div>
    </div>

    <h2 class="mb-3 sub-titulo text-center">Mis Facturas</h2>
    <table class="table table-bordered table-striped align-middle text-center">
        <thead class="table-dark">
            <tr>
                <th class="text-white">ID Factura</th>
                <th class="text-white">Fecha</th>
                <th class="text-white">Total</th>
                <th class="text-white">Detalles</th>
            </tr>
        </thead>
        <tbody id="tabla-facturas">
            <!-- Aquí se llenarán las filas -->
        </tbody>
    </table>

    <button id="btnCerrarSesion" class="btn btn-danger">Cerrar Sesión</button>
`;

                    // Cargar las facturas
                    cargarFacturas(usuario);

                    // Añadir evento para cerrar sesión
                    document.getElementById('btnCerrarSesion').addEventListener('click', cerrarSesion);
                })
                .catch(err => {
                    console.error("Error al obtener los datos del usuario:", err);
                    alert("❌ Error al obtener los datos del usuario.");
                });
        }

        // Cargar las facturas del usuario
        function cargarFacturas(usuario) {
            // Obtener las facturas del API
            fetch(`https://eltragolocorest.runasp.net/api/Factura`)
                .then(response => response.json())
                .then(facturas => {
                    // Filtrar las facturas por ciRuc y por estado "PAG"
                    const facturasUsuario = facturas.filter(factura => factura.USU_CI_RUC === usuario && factura.FAC_ESTADO === 'PAG');

                    // Verificar si la tabla existe, sino crearla
                    let tbody = document.getElementById('tabla-facturas');

                    // Si la tabla no existe, crearla
                    if (!tbody) {
                        // Crear la tabla
                        const table = document.createElement('table');
                        table.className = 'table table-bordered table-striped align-middle text-center';

                        // Crear el encabezado de la tabla
                        const thead = document.createElement('thead');
                        thead.className = 'table-dark';
                        thead.innerHTML = `
                        <tr>
                            <th class="text-white">ID Factura</th>
                            <th class="text-white">Fecha</th>
                            <th class="text-white">Total</th>
                            <th class="text-white">Detalles</th>
                        </tr>
                    `;
                        table.appendChild(thead);

                        // Crear el cuerpo de la tabla
                        tbody = document.createElement('tbody');
                        tbody.id = 'tabla-facturas';
                        table.appendChild(tbody);

                        // Agregar la tabla al contenedor
                        const contenidoPerfil = document.getElementById('contenidoPerfil');
                        contenidoPerfil.appendChild(table);
                    }

                    tbody.innerHTML = "";  // Limpiar tabla antes de mostrar las nuevas facturas

                    // Crear una fila para cada factura
                    facturasUsuario.forEach(factura => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                        <td>${factura.FAC_NUMERO}</td>
                        <td>${factura.FAC_FECHA.split('T')[0]}</td>
                        <td>$${factura.FAC_TOTAL.toFixed(2)}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-morado" onclick="mostrarDetalle('${factura.FAC_NUMERO}')">Ver detalles</button>
                        </td>
                    `;
                        tbody.appendChild(tr);
                    });
                })
                .catch(err => {
                    console.error(err);
                    alert("❌ Error al cargar las facturas.", err);
                });
        }

        // Mostrar detalles de la factura
        function mostrarDetalle(facNumero) {
            // Obtener los detalles de la factura desde el API
            fetch(`https://eltragolocorest.runasp.net/api/DetalleFactura/${facNumero}`)
                .then(response => response.json())
                .then(detalles => {
                    const tbodyDetalle = document.getElementById('detalle-factura-body');
                    tbodyDetalle.innerHTML = ""; // Limpiar detalles anteriores

                    let totalFactura = 0;
                    detalles.forEach(detalle => {
                        // Obtener el nombre del producto usando su ID
                        fetch(`https://eltragolocorest.runasp.net/api/Producto/${detalle.PROD_ID}`)
                            .then(response => response.json())
                            .then(producto => {
                                const subtotal = detalle.DXF_CANTIDAD * detalle.DXF_PRECIO_UNIT;
                                totalFactura += subtotal;

                                const tr = document.createElement('tr');
                                tr.innerHTML = `
                                <td>${producto.PROD_NOMBRE}</td>
                                <td>${detalle.DXF_CANTIDAD}</td>
                                <td>$${detalle.DXF_PRECIO_UNIT.toFixed(2)}</td>
                                <td>$${subtotal.toFixed(2)}</td>
                            `;
                                tbodyDetalle.appendChild(tr);
                            })
                            .catch(err => console.error(err));
                    });

                    // Mostrar el total de la factura
                    const trTotal = document.createElement('tr');
                    trTotal.innerHTML = `
                    <td colspan="3" class="text-end">Total:</td>
                    <td>$${totalFactura.toFixed(2)}</td>
                `;
                    tbodyDetalle.appendChild(trTotal);

                    const modal = new bootstrap.Modal(document.getElementById('modalDetalleFactura'));
                    modal.show();
                })
                .catch(err => {
                    console.error(err);
                    alert("❌ Error al cargar los detalles de la factura.");
                });
        }

        // Mostrar formulario de login
        function mostrarLogin() {
            const contenidoPerfil = document.getElementById('contenidoPerfil');
            contenidoPerfil.innerHTML = `
            <div class="login-container">
                <h2 class="mb-4 text-dark">Iniciar Sesión</h2>
                <form id="formLogin" novalidate>
                    <div class="mb-3 text-start">
                        <label for="cedula" class="form-label">Cédula:</label>
                        <input type="text" id="cedula" name="cedula" class="form-control" required maxlength="13"
                            pattern="\\d{10,13}" title="Ingrese una cédula o RUC válida" aria-describedby="cedulaHelp" />
                        <div id="cedulaHelp" class="form-text">Ingrese su cédula o RUC (10-13 dígitos).</div>
                    </div>

                    <div class="mb-3 text-start">
                        <label for="contrasena" class="form-label">Contraseña:</label>
                        <input type="password" id="contrasena" name="contrasena" class="form-control" required aria-describedby="contrasenaHelp" />
                        <div id="contrasenaHelp" class="form-text">Ingrese su contraseña.</div>
                    </div>

                    <button type="submit" class="btn btn-morado w-100 fw-bold">Ingresar</button>

                    <div class="mt-3">
                        <span>¿No tienes cuenta?</span>
                        <a href="Registro.html" class="text-decoration-none fw-bold text-danger">Regístrate aquí</a>
                    </div>
                </form>
            </div>
        `;

            // Manejo del formulario de login
            const form = document.getElementById("formLogin");

            form.addEventListener("submit", function (e) {
                e.preventDefault(); // Evitar el envío del formulario

                const cedula = form.cedula.value.trim();
                const contrasena = form.contrasena.value.trim();

                if (cedula && contrasena) {
                    // Llamada a la API para validar el login
                    fetch(`https://eltragolocorest.runasp.net/api/Login/Usuario/${cedula}`)
                        .then(res => {
                            if (!res.ok) throw new Error("Usuario no encontrado");
                            return res.json();
                        })
                        .then(data => {
                            // Verificar la contraseña
                            if (data.PASSWORD === contrasena) {
                                // Login exitoso
                                localStorage.setItem("usuario", cedula); // Guardar usuario en localStorage
                                window.location.reload(); // Recargar la página para mostrar los datos del usuario
                            } else {
                                alert("❌ Usuario o contraseña incorrectos.");
                                document.getElementById("contrasena").value = ''; // Limpiar el campo contraseña
                                document.getElementById("contrasena").focus();
                            }
                        })
                        .catch(err => {
                            console.error(err);
                            alert("❌ Error al autenticar. Verifique sus credenciales.");
                            document.getElementById("contrasena").value = ''; // Limpiar el campo contraseña
                            document.getElementById("contrasena").focus();
                        });
                } else {
                    alert("Por favor, ingrese su cédula y contraseña.");
                }
            });
        }

        // Cerrar sesión
        function cerrarSesion() {
            localStorage.removeItem("usuario");
            window.location.reload();
        }

        document.addEventListener("DOMContentLoaded", function () {
  // Aplica el modo guardado aunque el switch esté en el header
  if (localStorage.getItem('dark-mode') === 'enabled') {
    document.body.classList.add('dark-mode');
  }
});
    </script>

</body>

</html>